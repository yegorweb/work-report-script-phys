MY_NAME="Егор Князев"
MY_NAME_IN_BANK="Егор К."
MY_PHONE_NUMBER="+79999999999"
MY_BANK_NAME="Т-Банк"
TELEGRAM_NICKNAME="yegorwebdev"
TELEGRAM_BASE64="PD94bWwgdmVyc2lvbj0iMS4wIj8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmlld0JveD0iMCAwIDI0MC4xIDI0MC4xIj4KPGxpbmVhckdyYWRpZW50IGlkPSJPdmFsXzFfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9Ii04MzguMDQxIiB5MT0iNjYwLjU4MSIgeDI9Ii04MzguMDQxIiB5Mj0iNjYwLjM0MjciIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoMTAwMCAwIDAgLTEwMDAgODM4MTYxIDY2MDU4MSkiPgogPHN0b3Agb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojMkFBQkVFIi8+CiA8c3RvcCBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMyMjlFRDkiLz4KPC9saW5lYXJHcmFkaWVudD4KPGNpcmNsZSBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZmlsbD0idXJsKCNPdmFsXzFfKSIgY3g9IjEyMC4xIiBjeT0iMTIwLjEiIHI9IjEyMC4xIi8+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBmaWxsPSIjRkZGRkZGIiBkPSJNNTQuMywxMTguOGMzNS0xNS4yLDU4LjMtMjUuMyw3MC0zMC4yIGMzMy4zLTEzLjksNDAuMy0xNi4zLDQ0LjgtMTYuNGMxLDAsMy4yLDAuMiw0LjcsMS40YzEuMiwxLDEuNSwyLjMsMS43LDMuM3MwLjQsMy4xLDAuMiw0LjdjLTEuOCwxOS05LjYsNjUuMS0xMy42LDg2LjMgYy0xLjcsOS01LDEyLTguMiwxMi4zYy03LDAuNi0xMi4zLTQuNi0xOS05Yy0xMC42LTYuOS0xNi41LTExLjItMjYuOC0xOGMtMTEuOS03LjgtNC4yLTEyLjEsMi42LTE5LjFjMS44LTEuOCwzMi41LTI5LjgsMzMuMS0zMi4zIGMwLjEtMC4zLDAuMS0xLjUtMC42LTIuMWMtMC43LTAuNi0xLjctMC40LTIuNS0wLjJjLTEuMSwwLjItMTcuOSwxMS40LTUwLjYsMzMuNWMtNC44LDMuMy05LjEsNC45LTEzLDQuOCBjLTQuMy0wLjEtMTIuNS0yLjQtMTguNy00LjRjLTcuNS0yLjQtMTMuNS0zLjctMTMtNy45QzQ1LjcsMTIzLjMsNDguNywxMjEuMSw1NC4zLDExOC44eiIvPgo8L3N2Zz4K"
BANK_LINK=""
BANK_ICON_BASE64="PD94bWwgdmVyc2lvbj0iMS4wIj8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmlld0JveD0iMCAwIDI0MC4xIDI0MC4xIj4KPGxpbmVhckdyYWRpZW50IGlkPSJPdmFsXzFfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9Ii04MzguMDQxIiB5MT0iNjYwLjU4MSIgeDI9Ii04MzguMDQxIiB5Mj0iNjYwLjM0MjciIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoMTAwMCAwIDAgLTEwMDAgODM4MTYxIDY2MDU4MSkiPgogPHN0b3Agb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojMkFBQkVFIi8+CiA8c3RvcCBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMyMjlFRDkiLz4KPC9saW5lYXJHcmFkaWVudD4KPGNpcmNsZSBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZmlsbD0idXJsKCNPdmFsXzFfKSIgY3g9IjEyMC4xIiBjeT0iMTIwLjEiIHI9IjEyMC4xIi8+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBmaWxsPSIjRkZGRkZGIiBkPSJNNTQuMywxMTguOGMzNS0xNS4yLDU4LjMtMjUuMyw3MC0zMC4yIGMzMy4zLTEzLjksNDAuMy0xNi4zLDQ0LjgtMTYuNGMxLDAsMy4yLDAuMiw0LjcsMS40YzEuMiwxLDEuNSwyLjMsMS43LDMuM3MwLjQsMy4xLDAuMiw0LjdjLTEuOCwxOS05LjYsNjUuMS0xMy42LDg2LjMgYy0xLjcsOS01LDEyLTguMiwxMi4zYy03LDAuNi0xMi4zLTQuNi0xOS05Yy0xMC42LTYuOS0xNi41LTExLjItMjYuOC0xOGMtMTEuOS03LjgtNC4yLTEyLjEsMi42LTE5LjFjMS44LTEuOCwzMi41LTI5LjgsMzMuMS0zMi4zIGMwLjEtMC4zLDAuMS0xLjUtMC42LTIuMWMtMC43LTAuNi0xLjctMC40LTIuNS0wLjJjLTEuMSwwLjItMTcuOSwxMS40LTUwLjYsMzMuNWMtNC44LDMuMy05LjEsNC45LTEzLDQuOCBjLTQuMy0wLjEtMTIuNS0yLjQtMTguNy00LjRjLTcuNS0yLjQtMTMuNS0zLjctMTMtNy45QzQ1LjcsMTIzLjMsNDguNywxMjEuMSw1NC4zLDExOC44eiIvPgo8L3N2Zz4K"
QR_CODE_BASE64="PD94bWwgdmVyc2lvbj0iMS4wIj8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmlld0JveD0iMCAwIDI0MC4xIDI0MC4xIj4KPGxpbmVhckdyYWRpZW50IGlkPSJPdmFsXzFfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9Ii04MzguMDQxIiB5MT0iNjYwLjU4MSIgeDI9Ii04MzguMDQxIiB5Mj0iNjYwLjM0MjciIGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoMTAwMCAwIDAgLTEwMDAgODM4MTYxIDY2MDU4MSkiPgogPHN0b3Agb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojMkFBQkVFIi8+CiA8c3RvcCBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMyMjlFRDkiLz4KPC9saW5lYXJHcmFkaWVudD4KPGNpcmNsZSBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZmlsbD0idXJsKCNPdmFsXzFfKSIgY3g9IjEyMC4xIiBjeT0iMTIwLjEiIHI9IjEyMC4xIi8+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBmaWxsPSIjRkZGRkZGIiBkPSJNNTQuMywxMTguOGMzNS0xNS4yLDU4LjMtMjUuMyw3MC0zMC4yIGMzMy4zLTEzLjksNDAuMy0xNi4zLDQ0LjgtMTYuNGMxLDAsMy4yLDAuMiw0LjcsMS40YzEuMiwxLDEuNSwyLjMsMS43LDMuM3MwLjQsMy4xLDAuMiw0LjdjLTEuOCwxOS05LjYsNjUuMS0xMy42LDg2LjMgYy0xLjcsOS01LDEyLTguMiwxMi4zYy03LDAuNi0xMi4zLTQuNi0xOS05Yy0xMC42LTYuOS0xNi41LTExLjItMjYuOC0xOGMtMTEuOS03LjgtNC4yLTEyLjEsMi42LTE5LjFjMS44LTEuOCwzMi41LTI5LjgsMzMuMS0zMi4zIGMwLjEtMC4zLDAuMS0xLjUtMC42LTIuMWMtMC43LTAuNi0xLjctMC40LTIuNS0wLjJjLTEuMSwwLjItMTcuOSwxMS40LTUwLjYsMzMuNWMtNC44LDMuMy05LjEsNC45LTEzLDQuOCBjLTQuMy0wLjEtMTIuNS0yLjQtMTguNy00LjRjLTcuNS0yLjQtMTMuNS0zLjctMTMtNy45QzQ1LjcsMTIzLjMsNDguNywxMjEuMSw1NC4zLDExOC44eiIvPgo8L3N2Zz4K"

import sys, os
import subprocess, shlex
from PyPDF2 import PdfMerger

# Папки
root = os.getcwd()
image_folder = os.path.join(root, 'Рисунки')
image_edit_folder = os.path.join(root, 'Отредактированные рисунки')
from_done_folder = os.path.join(root, 'Из готовых')
probes_folder = os.path.join(root, 'Пробники')

figure_allowed_extensions = {'.jpg', '.jpeg', '.png', '.svg'}

pdfs = []
images = []
edit_images = []
pdfs_from_done = []
probes = []

# Настройки
try: settings = open(os.path.join(root, 'Настройки.txt'), 'r', encoding='utf-8', errors='Нет файла настроек').read().split('\n')
except FileNotFoundError: sys.exit('Нет файла с настройками')
except Exception as e: sys.exit(f'Ошибка: {e}')

try: period = settings[1]
except: sys.exit('Нет периода')

def get_setting(index):
    try: return settings[index]
    except: return ''

solves_amount = get_setting(3)
probes_text = get_setting(5)
new_docs_for_lessons = get_setting(7)

# Получаем документы
for filename in os.listdir(root):
    if (os.path.splitext(filename)[1].lower() == '.pdf') and (not 'Отчёт' in filename):
        pdfs.append(os.path.join(root, filename))
pdfs = sorted(pdfs)

# Получаем рисунки
for filename in os.listdir(image_folder):
    if (os.path.splitext(filename)[1].lower() in figure_allowed_extensions):
        images.append(os.path.join(os.path.split(image_folder)[1], filename))
images = sorted(images)

# Получаем отредактированные рисунки
for filename in os.listdir(image_edit_folder):
    if (os.path.splitext(filename)[1].lower() in figure_allowed_extensions):
        edit_images.append(os.path.join(os.path.split(image_edit_folder)[1], filename))
edit_images = sorted(edit_images)

# Получаем документы
for filename in os.listdir(from_done_folder):
    if (os.path.splitext(filename)[1].lower() == '.pdf'):
        pdfs_from_done.append(os.path.join(from_done_folder, filename))
pdfs_from_done = sorted(pdfs_from_done)

for filename in os.listdir(probes_folder):
    if (os.path.splitext(filename)[1].lower() == '.pdf'):
        probes.append(os.path.join(probes_folder, filename))
probes = sorted(probes)

try: new_docs_from_ready_code = settings[9]
except: new_docs_from_ready_code = len(pdfs_from_done) if len(pdfs_from_done) > 0 else ''

if len(probes) > 0: pdfs = probes + pdfs

print('Файлы просканированы')

created_images_code = f"""
== Созданные рисунки

#grid(
  columns: 2,
  gutter: 1.5em,
  
{'\n'.join([f'  align(horizon, image("{file.replace('\\', '/')}")),' for file in images])}  
)
""" if len(images) > 0 else ""

edit_images_code = f"""== Отредактированные рисунки

#grid(
  columns: 2,
  gutter: 1.5em,
  
{'\n'.join([f'  align(horizon, image("{file.replace('\\', '/')}")),' for file in edit_images])}  
)""" if len(edit_images) > 0 else ""

REM=18

output = f"""#import "@preview/based:0.2.0": base64
#set page(height: auto, margin: {'auto' if len(pdfs)==0 and len(pdfs_from_done)==0 else '(bottom: 1.5cm)'})
#show heading: it => align(center, it)
#set text(size: {REM}pt, lang: "ru")
#set underline(offset: 6pt)
#show link: it => text(size: {0.8*REM}pt, fill: rgb("229ED9"), underline(it))
#let mono = body => text(size: {0.8*REM}pt, font: "DejaVu Sans Mono", body)
#let telegram-link = [#box(block(image(base64.decode("{TELEGRAM_BASE64}"), height: {REM*16/18*0.85}pt), inset: -3pt)) #h(3pt) #link("https://t.me/{TELEGRAM_NICKNAME}", mono(text(size: 13pt)[#(sym.at){TELEGRAM_NICKNAME}]))]

== Отчёт за `{period}`

/ Исполнитель: #mono[{MY_NAME}] #h(10pt) #telegram-link{
f'\n/ Затехано решений: #mono[{solves_amount}]' if solves_amount != '' else ''
}{f'\n/ Создано пробников: #mono[{probes_text}]' if len(probes) > 0 or probes_text!='' else ''
}{f'\n/ Создано рисунков: #mono[{len(images)}]' if len(images) > 0 else ''
}{f'\n/ Отредактировано рисунков: #mono[{len(edit_images)}]' if len(edit_images) > 0 else ''
}{f'\n/ Затехано документов с задачами для занятий или ДЗ: #mono[{new_docs_for_lessons}]' if len(new_docs_for_lessons) > 0 else ''
}{f'\n/ Составлено документов с задачами для занятий или ДЗ из готового кода: #mono[{new_docs_from_ready_code}]' if new_docs_from_ready_code != '' else ''
}
/ Оплата труда:
#v(-0.5em)
#align(center,
    grid(
        columns: 2,
        column-gutter: 1em,
        align: horizon,
        [
            #box(block(
                image(base64.decode("{BANK_ICON_BASE64}"), height: 1.1em),
                inset: -4pt
            )) #h(0.35em) #link("{BANK_LINK}", text(size: 18pt)[Перевод по клику])
            #v(-0.1em)
            #mono[{MY_PHONE_NUMBER} ({MY_BANK_NAME})]
            #v(-0.2em)
            #mono[{MY_NAME_IN_BANK}]
        ],
        image(base64.decode("{QR_CODE_BASE64}"), height: 4cm)
    )
)

{created_images_code}

{edit_images_code}

{'#v(2em)' if created_images_code != '' or edit_images_code != '' or len(pdfs) == 0 else ''}

{'''
#set text(size: 24pt)
#align(center)[= Созданные документы]
''' if len(pdfs) > 0 else ''}
"""

f = open('output.typ', 'w', encoding='utf-8')
f.write(output)
f.close()

result_output_typ = subprocess.run(shlex.split('typst compile output.typ "Отчёт.pdf"'), stdout=subprocess.PIPE, stderr=subprocess.PIPE)
error_output_typ = result_output_typ.stderr.decode('utf-8')

if error_output_typ:
    print('Произошла ошибка:')
    sys.exit(error_output_typ)

os.remove(os.path.join(root, 'output.typ'))

if len(pdfs_from_done) > 0:    
    f = open('from_done.typ', 'w', encoding='utf-8')
    f.write('''
    #set page(height: auto)
    #set text(size: 24pt)
    #align(center + horizon)[= Документы с задачами для занятий или ДЗ, составленные из готового кода]
    ''')
    f.close()
    result_fromdone_typ = subprocess.run(shlex.split('typst compile from_done.typ "Из готовых.pdf"'), stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    error_fromdone_typ = result_fromdone_typ.stderr.decode('utf-8')

    if error_fromdone_typ:
        print('Произошла ошибка:')
        sys.exit(error_fromdone_typ)
    else:
        os.remove(os.path.join(root, 'from_done.typ'))

print('Страница с кратким отчётом создана')

pdfs.insert(0, os.path.join(root, 'Отчёт.pdf'))

if len(pdfs_from_done) > 0:
    pdfs.append(os.path.join(root, 'Из готовых.pdf'))
    pdfs = pdfs + pdfs_from_done

merger = PdfMerger()
for pdf in pdfs:
    merger.append(pdf)
merger.write(f'Отчёт {MY_NAME} за {period}.pdf')
merger.close()

os.remove(os.path.join(root, 'Отчёт.pdf'))

if len(pdfs_from_done) > 0:
    os.remove(os.path.join(root, 'Из готовых.pdf'))

print('Отчёт создан!')
